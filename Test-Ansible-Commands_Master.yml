---
- hosts: all
  vars:
    hostname: shasha
  tasks:
    - set_fact:
        catalogName: "{{catalog_url.split('/')[-1]}}"
    - name: Download catalog from specified URL
      win_get_url:
        url: "{{catalog_url}}"
        dest: c:\DatabaseBkup\
        url_username: "{{url_username}}"
        url_password: "{{url_password}}"
    - name: Copy the Catalog file to Temp
      win_copy:
        src: C:\DatabaseBkup\{{catalogName}}
        dest: C:\temp\{{catalogName}}
        remote_src: yes
    - name: Rename the catalog file
      win_command: cmd.exe /C rename C:\temp\{{catalogName}} TestAnsible1.zip
    - name: Unzip the catalog to get metadataxml
      win_unzip:
        src: C:\temp\TestAnsible1.zip
        dest: C:\temp\temp
        rm: True
    - name: Run shell command to read xml file and NMX version
      win_shell: |
        [xml]$xml = Get-Content C:\temp\temp\MetaData.xml
        $xml.DatabaseList.Item.Info.CreatedBy
      register: shell_result
    - set_fact:
        buildnumber: "{{shell_result.stdout_lines[0]}}"
    - set_fact:
        version: "trunk"
      when: buildnumber.find("eng") != -1
    - set_fact:
        constructbuildnumber: "{{buildnumber.split('.')}}"
    - set_fact:
        version: "{{constructbuildnumber[0]}}.{{constructbuildnumber[1]}}.x.{{constructbuildnumber[3]}}"
      when: buildnumber.find("eng") == -1
    - set_fact:
        buildnumber: "{{constructbuildnumber[0]}}.{{constructbuildnumber[1]}}.{{constructbuildnumber[2]}}.{{constructbuildnumber[3]}}.{{ constructbuildnumber[4] | regex_replace('^0', '')}}"
    - name: Delete the Unzipped folder
      win_file:
        path: C:\Temp\Temp
        state: absent
    - name: Check if a service is installed
      win_service:
        name: XServer
      register: XMSService
    - name: Pause a service
      win_service:
        name: XServer
        state: stopped
      when: XMSService.state == started
#    - import_tasks: Install_Uninstall_NMX.yml
#      vars:
#        nmx_version: "{{version}}"
#        build_number: "{{buildnumber}}"
#        username: ""
#        password: ""
#        nmx_username: administrator
#        nmx_password: Harmonic2008
#when: shell_result.stdout_lines[0].find("eng") == -1
#    - set_fact:
#        constructbuildnumber: "{{shell_result.stdout_lines[0].split('.')}}"
#        version: "{{constructbuildnumber[0]}}.{{constructbuildnumber[1]}}.x.{{constructbuildnumber[3]}}"
#        buildnumber: "{constructbuildnumber[0]}}.{{constructbuildnumber[1]}}.{{constructbuildnumber[2]}}.{{constructbuildnumber[3]}}.{{constructbuildnumber[4]}}{{ constructbuildnumber[5] | regex_replace('^0/', '') }}"
#      when: shell_result.stdout_lines[0].find("eng") == -1		
#    - import_tasks: Test-Ansible-Commands.yml
#      vars:
#        hostname: abc
#    - import_tasks: Test-Ansible-Commands.yml
#      vars:
#        hostname: shashank
#    - name: Download ActivateCatalog zip
#      win_get_url:
#        url: "https://NMXAutomation@bitbucket360.harmonicinc.com/projects/NMXGROUP/repos/nmx_playbooks/browse/nmx_playbooks/Install_Uninstall_NMX.yml"
#        dest: c:\temp\  
#$xml.DatabaseList.Item.Info.CreatedBy	 
#    - name: Copy the Activate Catalog file
#      win_copy:
#        src: C:\DatabaseBkup\TestAnsible.hzp
#        dest: C:\temp\TestAnsible.hzp
#        remote_src: yes
#    - name: rename the file
#      win_command: cmd.exe /C rename C:\temp\TestAnsible.hzp TestAnsible1.zip
#    - name: Unzip the Download ActivateCatalog zip
#      win_unzip:
#        src: C:\DatabaseBkup\TestAnsible1.zip
#        dest: C:\temp\
#        rm: True